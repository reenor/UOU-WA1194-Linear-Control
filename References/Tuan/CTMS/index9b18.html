<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

	
<!-- Mirrored from ctms.engin.umich.edu/CTMS/index.php?example=Introduction&section=ControlStateSpace by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 19 Jun 2014 21:09:26 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>

		<script type="text/javascript" src="jquery.js"></script>
					
		<link rel='stylesheet' type='text/css' href='style.css' />
		<script type="text/javascript">
	
			var example = "Introduction"; 
			var section = "ControlStateSpace"; 
			var aux = ""; 
			var effects = Boolean(1); 
			var tips = Boolean(1); 
			$.fx.off = !effects;
			
			$(document).keydown(function(e){
				if (!$("#search_field").is(":focus")){
					if (e.keyCode == 39) { 
						window.location = "index4e79.html?example=Introduction&amp;section=ControlDigital";
					}
					if (e.keyCode == 37) { 
						window.history.back()
					}
				}
			});		
			
		</script>
			
		<meta http-equiv="Content-Type" Content="text/html; charset=utf-8" />
		<meta http-equiv="PRAGMA" Content="NO-CACHE" />
		
		<title>Control Tutorials for MATLAB and Simulink - Introduction: State-Space Methods for Controller Design</title>
			
	</head>

	<body>
	
		
		<div id="container">
		
			<form id="search_form"><input id="search_field" type="text" name="q" placeholder="Search Control Tutorials"/></form>
			<form class="option_form" method="post" onclick="submit()"><div>Effects</div><input type="hidden" name="effects" value="0"/><input type="checkbox" name="effects" value="1" checked='true' /></form>
			<form class="option_form" method="post" onclick="submit()"><div>Tips</div><input type="hidden" name="tips" value="0"/><input type="checkbox" name="tips" value="1" checked='true' /></form>	
				
			<div style="clear:both"></div>
		
			<div id="header">
		
				

				
				
				<div id="menu_container">
				
					<ul class="menu">
						<li class="heading" id="Tips"><a href="index80e7.html?aux=Extras_Tips">TIPS</a></li>
						<div class="collapse"><div class="expand">
						</div></div>
					</ul>
				
					<ul class="menu">
						<li class="heading" id="About"><a>ABOUT</a></li>
						<div class="collapse"><div class="expand">
							<li class="item" id="About_Tutorials"><a href="index64fe.html?aux=About_Tutorials">Tutorials</a></li>
							<li class="item" id="About_Contact"><a href="mailto:ControlTutorialsMatlabSimulink@gmail.com">Contact</a></li>
						</div></div>
					</ul>
					
					<ul class="menu">
						<li class="heading" id="Basics"><a>BASICS</a></li>
						<div class="collapse"><div class="expand">
							<li class="item" id="Basics_Matlab"><a href="index87b6.html?aux=Basics_Matlab">MATLAB</a></li>
							<li class="item" id="Basics_Simulink"><a href="indexe9ea.html?aux=Basics_Simulink">Simulink</a></li>
						</div></div>
					</ul>
					
					<ul class="menu">
						<li class="heading" id="Index"><a>INDEX</a></li>
						<div class="collapse"><div class="expand">
							<li class="item" id="Index_Tutorials"><a href="index5e52.html?aux=Index_Tutorials">Tutorials</a></li>
							<li class="item" id="Index_Commands"><a href="index111e.html?aux=Index_Commands">Commands</a></li>
							<li class="item" id="Index_Animations"><a href="indexc3c5.html?aux=Index_Animations">Animations</a></li>
							<li class="item" id="Index_Extras"><a href="indexb290.html?aux=Index_Extras">Extras</a></li>
						</div></div>
					</ul>
									
					<ul class="menu">
						<li class="heading" id="Next"><a href="index4e79.html?example=Introduction&amp;section=ControlDigital">NEXT&nbsp;&#x25BA;</a></li>
						<div class="collapse"><div class="expand">
						</div></div>
					</ul>
											
				</div>

			</div>
			
			<div id="body_container">
			
				<div id="gradient_container"></div>
			
				<div id="top">
				
					<a href="index1304.html?aux=Home"><img id="CTMS_logo" src="Images/CTMS_logo.png"></a>
				
					<ul class="example">
					
						<li class="item" id="Introduction"><a href="index9b18.html?example=Introduction&amp;section=ControlStateSpace"><img class="icon" src="Images/Introduction_Icon.png"><div class="tab">INTRODUCTION</div></a></li>
						<li class="item" id="CruiseControl"><a href="index1502.html?example=CruiseControl&amp;section=ControlStateSpace"><img class="icon" src="Images/CruiseControl_Icon.png"><div class="tab">CRUISE&nbsp;CONTROL</div></a></li>
						<li class="item" id="MotorSpeed"><a href="indexd22e.html?example=MotorSpeed&amp;section=ControlStateSpace"><img class="icon" src="Images/MotorSpeed_Icon.png"><div class="tab">MOTOR&nbsp;SPEED</div></a></li>
						<li class="item" id="MotorPosition"><a href="indexc79c.html?example=MotorPosition&amp;section=ControlStateSpace"><img class="icon" src="Images/MotorPosition_Icon.png"><div class="tab">MOTOR&nbsp;POSITION</div></a></li>
						<li class="item" id="Suspension"><a href="index7de2.html?example=Suspension&amp;section=ControlStateSpace"><img class="icon" src="Images/Suspension_Icon.png"><div class="tab">SUSPENSION</div></a></li>
						<li class="item" id="InvertedPendulum"><a href="index96a8.html?example=InvertedPendulum&amp;section=ControlStateSpace"><img class="icon" src="Images/InvertedPendulum_Icon.png"><div class="tab">INVERTED&nbsp;PENDULUM</div></a></li>
						<li class="item" id="AircraftPitch"><a href="indexcff8.html?example=AircraftPitch&amp;section=ControlStateSpace"><img class="icon" src="Images/AircraftPitch_Icon.png"><div class="tab">AIRCRAFT&nbsp;PITCH</div></a></li>
						<li class="item" id="BallBeam"><a href="indexfa3e.html?example=BallBeam&amp;section=ControlStateSpace"><img class="icon" src="Images/BallBeam_Icon.png"><div class="tab">BALL&nbsp;&amp;&nbsp;BEAM</div></a></li>
					
					</ul> 
		
				</div>
				
				<div id="content_container">
					<div class="content">
   <div class="content_fx">
      <h1>Introduction: State-Space Methods for Controller Design</h1>
      <!--introduction-->
      <p>In this section, we will show how to design controllers and observers using state-space (or time-domain) methods.</p>
      <p>Key MATLAB commands used in this tutorial are: <a href="http://www.mathworks.com/help/techdoc/ref/eig.html"><tt>eig</tt></a> , <a href="http://www.mathworks.com/help/toolbox/control/ref/ss.html"><tt>ss</tt></a> , <a href="http://www.mathworks.com/help/toolbox/control/ref/lsim.html"><tt>lsim</tt></a> , <a href="http://www.mathworks.com/help/toolbox/control/ref/place.html"><tt>place</tt></a> , <a href="http://www.mathworks.com/help/toolbox/control/ref/acker.html"><tt>acker</tt></a></p>
      <!--/introduction-->
      <h2>Contents</h2>
      <div>
         <ul>
            <li><a href="#1">Modeling</a></li>
            <li><a href="#17">Stability</a></li>
            <li><a href="#23">Controllability and Observability</a></li>
            <li><a href="#24">Control Design Using Pole Placement</a></li>
            <li><a href="#35">Introducing the Reference Input</a></li>
            <li><a href="#45">Observer Design</a></li>
         </ul>
      </div>
      <h2>Modeling<a name="1"></a></h2>
      <p>There are several different ways to describe a system of linear differential equations.  The <b>state-space representation</b> was introduced in the <a href="indexf617.html?example=Introduction&amp;section=SystemModeling">Introduction: System Modeling</a> section.  For a SISO LTI system, the state-space form is given below:
      </p>
      <p><span class="eqn_num">(1)</span><img class="display_eqn" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_eq66813.png" alt="$$&#xA;\frac{d\mathbf{x}}{dt} = A\mathbf{x} + Bu&#xA;$$"></p>
      <p><span class="eqn_num">(2)</span><img class="display_eqn" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_eq00652.png" alt="$$&#xA;y = C\mathbf{x} + Du&#xA;$$"></p>
      <p>where <b>x</b> is a n by 1 vector representing the state (commonly position and velocity variable in mechanical systems), <tt>u</tt> is a scalar representing the input (commonly a force or torque in mechanical systems), and <tt>y</tt> is a scalar representing the output.  The matrices A (n by n), B (n by 1), and C (1 by n) determine the relationships between
         the state and input and output variables.  Note that there are n first-order differential equations.  State space representation
         can also be used for systems with multiple inputs and outputs (MIMO), but we will only use single-input, single-output (SISO)
         systems in these tutorials.
      </p>
      <p>To introduce the state space design method, we will use the magnetically suspended ball as an example.  The current through
         the coils induces a magnetic force which can balance the force of gravity and cause the ball (which is made of a magnetic
         material) to be suspended in midair.  The modeling of this system has been established in many control text books (including
         <i>Automatic Control Systems</i> by B. C. Kuo, the seventh edition).
      </p>
      <p><img class="figure"vspace="5" hspace="5" src="Content/Introduction/Control/StateSpace/figures/StateSpaceTutorial_StateSpaceEquations_MagneticModel.png" alt=""> </p>
      <p>The equations for the system are given by:</p>
      <p><span class="eqn_num">(3)</span><img class="display_eqn" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_eq42684.png" alt="$$&#xA;M\frac{d^2h}{dt^2} = Mg - \frac{Ki^2}{h}&#xA;$$"></p>
      <p><span class="eqn_num">(4)</span><img class="display_eqn" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_eq20004.png" alt="$$&#xA;V = L\frac{di}{dt} + iR&#xA;$$"></p>
      <p>where <tt>h</tt> is the vertical position of the ball, <tt>i</tt> is the current through the electromagnet, <tt>V</tt> is the applied voltage, <tt>M</tt> is the mass of the ball, <tt>g</tt> is gravity, <tt>L</tt> is the inductance, <tt>R</tt> is the resistance, and <tt>K</tt> is a coefficient that determines the magnetic force exerted on the ball.  For simplicity, we will choose values <tt>M = 0.05 Kg</tt>, <tt>K = 0.0001</tt>, <tt>L = 0.01 H</tt>, <tt>R = 1 Ohm</tt>, <tt>g = 9.81 m/sec^2</tt>. The system is at equilibrium (the ball is suspended in midair) whenever <tt>h = K i^2/Mg</tt> (at which point <tt>dh/dt = 0</tt>).  We linearize the equations about the point <tt>h = 0.01 m</tt> (where the nominal current is about 7 amp) and get the state space equations:
      </p>
      <p><span class="eqn_num">(5)</span><img class="display_eqn" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_eq30089.png" alt="$$&#xA;\frac{d\vec{x}}{dt} = A\vec{x} + Bu&#xA;$$"></p>
      <p><span class="eqn_num">(6)</span><img class="display_eqn" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_eq78855.png" alt="$$&#xA;y = C\vec{x} + Du&#xA;$$"></p>
      <p>where:</p>
      <p><span class="eqn_num">(7)</span><img class="display_eqn" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_eq93162.png" alt="$$&#xA;x =&#xA;\left[{\begin{array}{c}&#xA;  \Delta h \\ \Delta \dot{h} \\ \Delta i&#xA;\end{array}}\right]&#xA;$$"></p>
      <p>is the set of state variables for the system (a 3x1 vector), <tt>u</tt> is the input voltage (delta <tt>V</tt>), and <tt>y</tt> (the output), is delta <tt>h</tt>.  Enter the system matricies into a <tt>m-file</tt>.
      </p><pre class="codeinput">A = [ 0   1   0
     980  0  -2.8
      0   0  -100 ];

B = [ 0
      0
      100 ];

C = [ 1 0 0 ];
</pre><h2>Stability<a name="17"></a></h2>
      <p>One of the first things we want to do is analyze whether the open-loop system (without any control) is stable.  As discussed
         in the <a href="indexa13b.html?example=Introduction&amp;section=SystemAnalysis">Introduction: System Analysis</a> section, the eigenvalues of the system matrix, A, (equivalent to the poles of the transfer fucntion) determine the stability.
         The eigenvalues of the A matrix are the values of <tt>s</tt> where <tt>det(sI - A) = 0</tt>.
      </p><pre class="codeinput">poles = eig(A)
</pre><pre class="codeoutput">poles =
   31.3050
  -31.3050
 -100.0000
</pre><p>One of the poles is in the right-half plane, (i.e. has positive real part which means that the system is unstable in open-loop.</p>
      <p>To check out what happens to this unstable system when there is a nonzero initial condition, add the following lines to your
         <tt>m-file</tt> and it again:
      </p><pre class="codeinput">t = 0:0.01:2;
u = zeros(size(t));
x0 = [0.01 0 0];

sys = ss(A,B,C,0);

[y,t,x] = lsim(sys,u,t,x0);
plot(t,y)
title(<span class="string">'Open-Loop Response to Non-Zero Initial Condition'</span>)
xlabel(<span class="string">'Time (sec)'</span>)
ylabel(<span class="string">'Ball Position (m)'</span>)
</pre><img class="figure"vspace="5" hspace="5" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_01.png" alt=""> <p>It looks like the distance between the ball and the electromagnet will go to infinity, but probably the ball hits the table
         or the floor first (and also probably goes out of the range where our linearization is valid).
      </p>
      <h2>Controllability and Observability<a name="23"></a></h2>
      <p>A system is <b>controllable</b> if there exists a control input, u(t), that transfers any state of the system to zero in finite time.  It can be shown that
         an LTI system is controllable if and only if its controllabilty matrix, CO, has full rank (i.e. if rank(CO) = n where n is
         the number of states ). The rank of the controllability matrix of an LTI model can be determined in MATLAB using the commands
         <tt>rank(ctrb(A,B))</tt> or <tt>rank(ctrb(sys))</tt>.
      </p>
      <p><span class="eqn_num">(8)</span><img class="display_eqn" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_eq90094.png" alt="$$&#xA;CO = [B | AB | A^2B | ... | A^{n-1}B];&#xA;$$"></p>
      <p>All the state variables of a system may not be directly measurable, for instance if the component is in an inaccessible location.
         In these cases it is neccesary to <b>estimate</b> the values of the unknown internal state variables using only the available system outputs.  A system is <b>observable</b> if the initial state, x(t_0), can be determined from the system output, y(t), over some finite time t_0 &lt; t &lt; t_f. For LTI
         systems, the system is observable if and only if the observability matrix, OB, has full rank (i.e. if rank(OB) = n where n
         is the number of states). The observability of an LTI model can be determined in MATLAB using the command <tt>rank(obsv(A,C))</tt> or <tt>rank(obsv(sys))</tt>.
      </p>
      <p><span class="eqn_num">(9)</span><img class="display_eqn" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_eq06968.png" alt="$$&#xA;OB = \left[ \begin{array}{c} C \\ CA \\ CA^2 \\ \vdots \\ CA^{n-1} \end{array} \right]&#xA;$$"></p>
      <p>Controllability and observability are <b>dual</b> concepts.  A system (A,B) is controllable if and only if a system (A',C,B',D) is observable. This fact will be useful when
         designing an observer, as we shall see below.
      </p>
      <h2>Control Design Using Pole Placement<a name="24"></a></h2>
      <p>Let's build a controller for this system using pole placement.  The schematic of a full-state feedback system is shown below.
          By full-state, we mean that all state variables are known to the controller at all times.  For instance in this system, we
         would need a sensor measuring the ball position, another measuring velocity, and a third measuring current in the electro-magnet.
      </p>
      <p><img class="figure"vspace="5" hspace="5" src="Content/Introduction/Control/StateSpace/figures/StateSpaceTutorial_ControlDesign_BlockDiagram.png" alt=""> </p>
      <p>For simplicity, let's assume the reference is zero, R=0.  The input is then</p>
      <p><span class="eqn_num">(10)</span><img class="display_eqn" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_eq95902.png" alt="$$&#xA;u = -Kx&#xA;$$"></p>
      <p>The state-space equations for the closed-loop feedback system are therefore</p>
      <p><span class="eqn_num">(11)</span><img class="display_eqn" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_eq04324.png" alt="$$&#xA;\dot{x} = (A-BK)x&#xA;$$"></p>
      <p><span class="eqn_num">(12)</span><img class="display_eqn" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_eq26308.png" alt="$$&#xA;y = (C-DK)x&#xA;$$"></p>
      <p>The stability and time domain performance of the closed-loop feedback system are determined primarily by the location of the
         poles (eigenvalues) of the matrix (A-BK).  Since the matrices A and B*K are both 3 by 3 matrices, there will be 3 poles for
         the system. By choosing an appropriate K matrix we can place these closed-loop poles anywhere we want. We can use the MATLAB
         function <tt>place</tt> to find the control matrix, K, which will give the desired poles.
      </p>
      <p>Before attempting this method, we have to decide where we want the closed-loop poles to be. Suppose the criteria for the controller
         were settling time &lt; 0.5 sec and overshoot &lt; 5%, then we might try to place the two dominant poles at -10 +/- 10i (at <tt>zeta</tt> = 0.7 or 45 degrees with <tt>sigma</tt> = 10 &gt; 4.6*2).  The third pole we might place at -50 to start, and we can change it later depending on what the closed-loop
         behavior is. Remove the <tt>lsim</tt> command from your <tt>m-file</tt> and everything after it, then add the following lines to your <tt>m-file</tt>:
      </p><pre class="codeinput">p1 = -10 + 10i;
p2 = -10 - 10i;
p3 = -50;

K = place(A,B,[p1 p2 p3]);
sys_cl = ss(A-B*K,B,C,0);

lsim(sys_cl,u,t,x0);
xlabel(<span class="string">'Time (sec)'</span>)
ylabel(<span class="string">'Ball Position (m)'</span>)
</pre><img class="figure"vspace="5" hspace="5" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_02.png" alt=""> <p>The overshoot is too large (there are also zeros in the transfer function which can increase the overshoot; you do not see
         the zeros in the state-space formulation).  Try placing the poles further to the left to see if the transient response improves
         (this should also make the response faster).
      </p><pre class="codeinput">p1 = -20 + 20i;
p2 = -20 - 20i;
p3 = -100;

K = place(A,B,[p1 p2 p3]);
sys_cl = ss(A-B*K,B,C,0);

lsim(sys_cl,u,t,x0);
xlabel(<span class="string">'Time (sec)'</span>)
ylabel(<span class="string">'Ball Position (m)'</span>)
</pre><img class="figure"vspace="5" hspace="5" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_03.png" alt=""> <p>This time the overshoot is smaller.  Consult your textbook for further suggestions on choosing the desired closed-loop poles.</p>
      <p>Compare the control effort required (K) in both cases.  In general, the farther you move the poles, the more control effort
         it takes.
      </p>
      <p><b>Note:</b> If you want to place two or more poles at the same position, <tt>place</tt> will not work.  You can use a function called <tt>acker</tt> which works similarly to place:
      </p>
      <p><tt>K = acker(A,B,[p1 p2 p3])</tt></p>
      <h2>Introducing the Reference Input<a name="35"></a></h2>
      <p>Now, we will take the control system as defined above and apply a step input (we choose a small value for the step, so we
         remain in the region where our linearization is valid).  Replace <tt>t</tt>,|u|, and <tt>lsim</tt> in your <tt>m-file</tt> with the following:
      </p><pre class="codeinput">t = 0:0.01:2;
u = 0.001*ones(size(t));

sys_cl = ss(A-B*K,B,C,0);

lsim(sys_cl,u,t);
xlabel(<span class="string">'Time (sec)'</span>)
ylabel(<span class="string">'Ball Position (m)'</span>)
axis([0 2 -4E-6 0])
</pre><img class="figure"vspace="5" hspace="5" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_04.png" alt=""> <p>The system does not track the step well at all; not only is the magnitude not one, but it is negative instead of positive!</p>
      <p>Recall the schematic above, we don't compare the output to the reference; instead we measure all the states, multiply by the
         gain vector K, and then subtract this result from the reference.  There is no reason to expect that K*x will be equal to the
         desired output.  To eliminate this problem, we can scale the reference input to make it equal to K*x steadystate.  This scale
         factor is often called <tt>Nbar</tt>; it is introduced as shown in the following schematic:
      </p>
      <p><img class="figure"vspace="5" hspace="5" src="Content/Introduction/Control/StateSpace/figures/StateSpaceTutorial_ReferenceInput_BlockDiagram.png" alt=""> </p>
      <p>We can get Nbar from MATLAB by using the function <tt>rscale</tt> (place the following line of code after <tt>K</tt> = ...).
      </p><pre class="codeinput">Nbar = rscale(sys,K)
</pre><pre class="codeoutput">Nbar =
 -285.7143
</pre><p>Note that this function is not standard in MATLAB.  You will need download it here, <a href="Content/Introduction/Control/StateSpace/rscale.m">rscale.m</a>, and save it to your current workspace. Now, if we want to find the response of the system under state feedback with this
         introduction of the reference, we simply note the fact that the input is multiplied by this new factor, <tt>Nbar</tt>:
      </p><pre class="codeinput">lsim(sys_cl,Nbar*u,t)
title(<span class="string">'Linear Simulation Results (with Nbar)'</span>)
xlabel(<span class="string">'Time (sec)'</span>)
ylabel(<span class="string">'Ball Position (m)'</span>)
axis([0 2 0 1.2*10^-3])
</pre><img class="figure"vspace="5" hspace="5" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_05.png" alt=""> <p>and now a step can be tracked reasonably well.</p>
      <h2>Observer Design<a name="45"></a></h2>
      <p>When we can't measure all the states <tt>x</tt> (often the case in practice), we can build an <b>observer</b> to estimate them, while measuring only the output <tt>y = C x</tt>.  For the magnetic ball example, we will add three new, estimated states to the system.  The schematic is as follows:
      </p>
      <p><img class="figure"vspace="5" hspace="5" src="Content/Introduction/Control/StateSpace/figures/StateSpaceTutorial_ObserverDesign_BlockDiagram.png" alt=""> </p>
      <p>The observer is basically a copy of the plant; it has the same input and almost the same differential equation.  An extra
         term compares the actual measured output <tt>y</tt> to the estimated output y_hat; this will cause the estimated states \hat{x} to approach the values of the actual states <tt>x</tt>. The error dynamics of the observer are given by the poles of (A-LC).
      </p>
      <p>First, we need to choose the observer gain L.  Since we want the dynamics of the observer to be much faster than the system
         itself, we need to place the poles at least five times farther to the left than the dominant poles of the system.  If we want
         to use <tt>place</tt>, we need to put the three observer poles at different locations.
      </p><pre class="codeinput">op1 = -100;
op2 = -101;
op3 = -102;
</pre><p>Because of the duality between controllability and observability, we can use the same technique used to find the control matrix,
         but replacing the matrix B by the matrix C and taking the transposes of each matrix
      </p><pre class="codeinput">L = place(A',C',[op1 op2 op3])';
</pre><p>The equations in the block diagram above are given for \hat{x}.  It is conventional to write the combined equations for the
         system plus observer using the original state <tt>x</tt> plus the error state: <tt>e = x - \hat{x}</tt>.  We use as state feedback <tt>u = -K \hat{x}</tt>.  After a little bit of algebra (consult your textbook for more details), we arrive at the combined state and error equations
         with the full-state feedback and an observer.
      </p><pre class="codeinput">At = [ A-B*K             B*K
       zeros(size(A))    A-L*C ];

Bt = [    B*Nbar
       zeros(size(B)) ];

Ct = [ C    zeros(size(C)) ];
</pre><p>To see how the response looks to a nonzero initial condition with no reference input, add the following lines into your <tt>m-file</tt>. We typically assume that the observer begins with zero initial condition, \hat{x} = 0. This gives us that the initial condition
         for the error is equal to the initial condition of the state.
      </p><pre class="codeinput">sys = ss(At,Bt,Ct,0);
lsim(sys,zeros(size(t)),t,[x0 x0]);

title(<span class="string">'Linear Simulation Results (with observer)'</span>)
xlabel(<span class="string">'Time (sec)'</span>)
ylabel(<span class="string">'Ball Position (m)'</span>)
</pre><img class="figure"vspace="5" hspace="5" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_06.png" alt=""> <p>Responses of all the states are plotted below.  Recall that <tt>lsim</tt> gives us <tt>x</tt> and <tt>e</tt>; to get <tt>\hat{x}</tt>, we need to compute <tt>x - e</tt>.
      </p><pre class="codeinput">t = 0:1E-6:0.1;
x0 = [0.01 0.5 -5];
[y,t,x] = lsim(sys,zeros(size(t)),t,[x0 x0]);

n = 3;
e = x(:,n+1:end);
x = x(:,1:n);
x_est = x - e;

<span class="comment">% Save state variables explicitly to aid in plotting</span>
h = x(:,1); h_dot = x(:,2); i = x(:,3);
h_est = x_est(:,1); h_dot_est = x_est(:,2); i_est = x_est(:,3);

plot(t,h,<span class="string">'-r'</span>,t,h_est,<span class="string">':r'</span>,t,h_dot,<span class="string">'-b'</span>,t,h_dot_est,<span class="string">':b'</span>,t,i,<span class="string">'-g'</span>,t,i_est,<span class="string">':g'</span>)
xlabel(<span class="string">'Time (sec)'</span>)
</pre><img class="figure"vspace="5" hspace="5" src="Content/Introduction/Control/StateSpace/html/Introduction_ControlStateSpace_07.png" alt=""> <p>We can see that the observer estimates the states quickly and tracks the states well in the steady-state.</p>
      <p class="footer"><br>
         Published with MATLAB&reg; 7.14<br></p>
   </div>
</div>
<!--
##### SOURCE BEGIN #####
%% Introduction: State-Space Methods for Controller Design
%
% In this section, we will show how to design controllers and observers
% using state-space (or time-domain) methods.
%
% Key MATLAB commands used in this tutorial are:
% <http://www.mathworks.com/help/techdoc/ref/eig.html |eig|> , 
% <http://www.mathworks.com/help/toolbox/control/ref/ss.html |ss|> , 
% <http://www.mathworks.com/help/toolbox/control/ref/lsim.html |lsim|> , 
% <http://www.mathworks.com/help/toolbox/control/ref/place.html |place|> , 
% <http://www.mathworks.com/help/toolbox/control/ref/acker.html |acker|>
%
%% Modeling
% There are several different ways to describe a system of linear
% differential equations.  The *state-space representation* was introduced 
% in the < ?example=Introduction&section=SystemModeling Introduction: System Modeling> 
% section.  For a SISO LTI system, the state-space form is given below:
%%
% $$
% \frac{d\mathbf{x}}{dt} = A\mathbf{x} + Bu
% $$
%
%%
% $$
% y = C\mathbf{x} + Du
% $$
%
%% 
% where *x* is a n by 1 vector representing the state (commonly position 
% and velocity variable in mechanical systems), |u| is a scalar 
% representing the input (commonly a force or torque in mechanical 
% systems), and |y| is a scalar representing the output.  The matrices A 
% (n by n), B (n by 1), and C (1 by n) determine the relationships 
% between the state and input and output variables.  Note that there are n 
% first-order differential equations.  State space representation can also 
% be used for systems with multiple inputs and outputs (MIMO), but we will 
% only use single-input, single-output (SISO) systems in these tutorials.
%
%%
% To introduce the state space design method, we will use the magnetically
% suspended ball as an example.  The current through the coils induces a 
% magnetic force which can balance the force of gravity and cause the ball 
% (which is made of a magnetic material) to be suspended in midair.  The 
% modeling of this system has been established in many control text books 
% (including _Automatic Control Systems_ by B. C. Kuo, the seventh 
% edition).
%
%%
%
% <<Content/Introduction/Control/StateSpace/figures/StateSpaceTutorial_StateSpaceEquations_MagneticModel.png>>
%
%%
% The equations for the system are given by:
%
%%
% $$
% M\frac{d^2h}{dt^2} = Mg - \frac{Ki^2}{h}
% $$
%
%%
% $$
% V = L\frac{di}{dt} + iR
% $$
%
%%
% where |h| is the vertical position of the ball, |i| is the current 
% through the electromagnet, |V| is the applied voltage, |M| is the mass of
% the ball, |g| is gravity, |L| is the inductance, |R| is the resistance, 
% and |K| is a coefficient that determines the magnetic force exerted on 
% the ball.  For simplicity, we will choose values |M = 0.05 Kg|, 
% |K = 0.0001|, |L = 0.01 H|, |R = 1 Ohm|, |g = 9.81 m/sec^2|. The system 
% is at equilibrium (the ball is suspended in midair) whenever 
% |h = K i^2/Mg| (at which point |dh/dt = 0|).  We linearize the equations 
% about the point |h = 0.01 m| (where the nominal current is about 7 amp) 
% and get the state space equations:
%
%%
% $$
% \frac{d\vec{x}}{dt} = A\vec{x} + Bu
% $$
%
%%
% $$
% y = C\vec{x} + Du
% $$
%
%%
% where:
%
%%
% $$
% x = 
% \left[{\begin{array}{c}
%   \Delta h \\ \Delta \dot{h} \\ \Delta i
% \end{array}}\right]
% $$
%
%%
% is the set of state variables for the system (a 3x1 vector), |u| is the
% input voltage (delta |V|), and |y| (the output), is delta |h|.  Enter the
% system matricies into a |m-file|.
%
%%

A = [ 0   1   0
     980  0  -2.8
      0   0  -100 ];

B = [ 0
      0
      100 ];
  
C = [ 1 0 0 ];

%% Stability
%
% One of the first things we want to do is analyze whether the open-loop
% system (without any control) is stable.  As discussed in the 
% < ?example=Introduction&section=SystemAnalysis Introduction: System Analysis>
% section, the eigenvalues of the system matrix, A, (equivalent to the poles 
% of the transfer fucntion) determine the stability. The eigenvalues of the A matrix are
% the values of |s| where |det(sI - A) = 0|.
%
%%

poles = eig(A)

%%
% One of the poles is in the right-half plane, (i.e. has positive real part
% which means that the system is unstable in open-loop.
%
%%
% To check out what happens to this unstable system when there is a nonzero
% initial condition, add the following lines to your |m-file| and it again:
%
%%

t = 0:0.01:2;
u = zeros(size(t));
x0 = [0.01 0 0];

sys = ss(A,B,C,0);

[y,t,x] = lsim(sys,u,t,x0);
plot(t,y)
title('Open-Loop Response to Non-Zero Initial Condition')
xlabel('Time (sec)')
ylabel('Ball Position (m)')

%%
% It looks like the distance between the ball and the electromagnet will go
% to infinity, but probably the ball hits the table or the floor first (and
% also probably goes out of the range where our linearization is valid).
%
%% Controllability and Observability
%
% A system is *controllable* if there exists a control input, u(t), that transfers 
% any state of the system to zero in finite time.  It can be shown that an LTI system 
% is controllable if and only if its controllabilty matrix, CO, has full rank 
% (i.e. if rank(CO) = n where n is the number of states ). 
% The rank of the controllability matrix of an LTI model can be determined 
% in MATLAB using the commands |rank(ctrb(A,B))| or |rank(ctrb(sys))|.
%
% $$
% CO = [B | AB | A^2B | ... | A^{n-1}B];
% $$
%
% All the state variables of a system may not be directly measurable, for
% instance if the component is in an inaccessible location. In these cases
% it is neccesary to *estimate* the values of the unknown internal state variables
% using only the available system outputs.  A system is *observable*
% if the initial state, x(t_0), can be determined from the system output,
% y(t), over some finite time t_0 < t < t_f. For LTI systems, the system
% is observable if and only if the observability matrix, OB, has full
% rank (i.e. if rank(OB) = n where n is the number of states). 
% The observability of an LTI model can be determined in MATLAB using the
% command |rank(obsv(A,C))| or |rank(obsv(sys))|.
%
% $$
% OB = \left[ \begin{array}{c} C \\ CA \\ CA^2 \\ \vdots \\ CA^{n-1} \end{array} \right]
% $$
%
% Controllability and observability are *dual* concepts.  A system (A,B) is
% controllable if and only if a system (A',C,B',D) is observable. This fact
% will be useful when designing an observer, as we shall see below.
%
%% Control Design Using Pole Placement
%
% Let's build a controller for this system using pole placement.  The schematic 
% of a full-state feedback system is shown below.  By full-state, we mean
% that all state variables are known to the controller at all times.  For
% instance in this system, we would need a sensor measuring the ball
% position, another measuring velocity, and a third measuring current in
% the electro-magnet.
%
%%
%
% <<Content/Introduction/Control/StateSpace/figures/StateSpaceTutorial_ControlDesign_BlockDiagram.png>>
%
%%
%
% For simplicity, let's assume the reference is zero, R=0.  The input is
% then 
%
% $$ 
% u = -Kx
% $$
%
% The state-space equations for the closed-loop feedback system are
% therefore
%
% $$
% \dot{x} = (A-BK)x
% $$
%
% $$
% y = (C-DK)x
% $$
%
% The stability and time domain performance of the closed-loop feedback 
% system are determined primarily by the location of the poles (eigenvalues) of the 
% matrix (A-BK).  Since the matrices A and B*K are both 3 by 3 matrices, 
% there will be 3 poles for the system. By choosing an appropriate K matrix
% we can place these closed-loop poles anywhere we want. We can use the 
% MATLAB function |place| to find the control matrix, K, which will give 
% the desired poles.
%
%%
% Before attempting this method, we have to decide where we want the
% closed-loop poles to be. Suppose the criteria for the controller were 
% settling time < 0.5 sec and overshoot < 5%, then we might try to place 
% the two dominant poles at -10 +/- 10i (at |zeta| = 0.7 or 45 degrees with
% |sigma| = 10 > 4.6*2).  The third pole we might place at -50 to start, 
% and we can change it later depending on what the closed-loop behavior is.
% Remove the |lsim| command from your |m-file| and everything after it, 
% then add the following lines to your |m-file|:
%
%%

p1 = -10 + 10i;
p2 = -10 - 10i;
p3 = -50;

K = place(A,B,[p1 p2 p3]);
sys_cl = ss(A-B*K,B,C,0);

lsim(sys_cl,u,t,x0);
xlabel('Time (sec)')
ylabel('Ball Position (m)')

%%
% The overshoot is too large (there are also zeros in the transfer function
% which can increase the overshoot; you do not see the zeros in the 
% state-space formulation).  Try placing the poles further to the left to 
% see if the transient response improves (this should also make the 
% response faster).
%
%%

p1 = -20 + 20i;
p2 = -20 - 20i;
p3 = -100;

K = place(A,B,[p1 p2 p3]);
sys_cl = ss(A-B*K,B,C,0);

lsim(sys_cl,u,t,x0);
xlabel('Time (sec)')
ylabel('Ball Position (m)')

%%
% This time the overshoot is smaller.  Consult your textbook for further
% suggestions on choosing the desired closed-loop poles.
%
%%
% Compare the control effort required (K) in both cases.  In general, the
% farther you move the poles, the more control effort it takes.
%
%%
% *Note:* If you want to place two or more poles at the same position,
% |place| will not work.  You can use a function called |acker| which works
% similarly to place:
%
%%
% |K = acker(A,B,[p1 p2 p3])|
%
%% Introducing the Reference Input
% Now, we will take the control system as defined above and apply a step
% input (we choose a small value for the step, so we remain in the region 
% where our linearization is valid).  Replace |t|,|u|, and |lsim| in your 
% |m-file| with the following:
%
%%

t = 0:0.01:2; 
u = 0.001*ones(size(t));

sys_cl = ss(A-B*K,B,C,0);

lsim(sys_cl,u,t);
xlabel('Time (sec)')
ylabel('Ball Position (m)')
axis([0 2 -4E-6 0])

%%
% The system does not track the step well at all; not only is the magnitude
% not one, but it is negative instead of positive! 
%
%%
% Recall the schematic above, we don't compare the output to the reference;
% instead we measure all the states, multiply by the gain vector K, and 
% then subtract this result from the reference.  There is no reason to 
% expect that K*x will be equal to the desired output.  To eliminate this
% problem, we can scale the reference input to make it equal to 
% K*x steadystate.  This scale factor is often called |Nbar|; it is 
% introduced as shown in the following schematic:
%
%%
%
% <<Content/Introduction/Control/StateSpace/figures/StateSpaceTutorial_ReferenceInput_BlockDiagram.png>>
%
%%
% We can get Nbar from MATLAB by using the function |rscale| (place the
% following line of code after |K| = ...). 
%
%%

Nbar = rscale(sys,K)

%%
% Note that this function is not standard in MATLAB.  You will need download 
% it here, <Content/Introduction/Control/StateSpace/rscale.m rscale.m>, and save it to your current workspace.  
% Now, if we want to find the response of the system under state feedback 
% with this introduction of the reference, we simply note the fact that the 
% input is multiplied by this new factor, |Nbar|:
%
%%

lsim(sys_cl,Nbar*u,t)
title('Linear Simulation Results (with Nbar)')
xlabel('Time (sec)')
ylabel('Ball Position (m)')
axis([0 2 0 1.2*10^-3])

%%
% and now a step can be tracked reasonably well.
%
%% Observer Design
%
% When we can't measure all the states |x| (often the case in practice), we
% can build an *observer* to estimate them, while measuring only the output
% |y = C x|.  For the magnetic ball example, we will add three new,
% estimated states to the system.  The schematic is as follows:
%
%%
%
% <<Content/Introduction/Control/StateSpace/figures/StateSpaceTutorial_ObserverDesign_BlockDiagram.png>>
%
%%
% The observer is basically a copy of the plant; it has the same input and
% almost the same differential equation.  An extra term compares the actual
% measured output |y| to the estimated output y_hat; this will cause the
% estimated states \hat{x} to approach the values of the actual states |x|.
% The error dynamics of the observer are given by the poles of (A-LC).
%
%%
% First, we need to choose the observer gain L.  Since we want the
% dynamics of the observer to be much faster than the system itself, we
% need to place the poles at least five times farther to the left than the
% dominant poles of the system.  If we want to use |place|, we need to put
% the three observer poles at different locations.
%
%%

op1 = -100;
op2 = -101;
op3 = -102;

%%
% Because of the duality between controllability and observability, we can
% use the same technique used to find the control matrix, but replacing the
% matrix B by the matrix C and taking the transposes of each matrix
%
%%

L = place(A',C',[op1 op2 op3])';

%%
% The equations in the block diagram above are given for \hat{x}.  It is
% conventional to write the combined equations for the system plus observer
% using the original state |x| plus the error state: |e = x - \hat{x}|.  We
% use as state feedback |u = -K \hat{x}|.  After a little bit of algebra
% (consult your textbook for more details), we arrive at the combined state
% and error equations with the full-state feedback and an observer.
%
%%

At = [ A-B*K             B*K
       zeros(size(A))    A-L*C ];
   
Bt = [    B*Nbar
       zeros(size(B)) ];
   
Ct = [ C    zeros(size(C)) ];

%%
% To see how the response looks to a nonzero initial condition with no
% reference input, add the following lines into your |m-file|. We typically
% assume that the observer begins with zero initial condition, \hat{x} = 0.
% This gives us that the initial condition for the error is equal to the 
% initial condition of the state.
%
%%

sys = ss(At,Bt,Ct,0);
lsim(sys,zeros(size(t)),t,[x0 x0]);

title('Linear Simulation Results (with observer)')
xlabel('Time (sec)')
ylabel('Ball Position (m)')

%%
% Responses of all the states are plotted below.  Recall that |lsim| gives
% us |x| and |e|; to get |\hat{x}|, we need to compute |x - e|.
%
%%

t = 0:1E-6:0.1;
x0 = [0.01 0.5 -5];
[y,t,x] = lsim(sys,zeros(size(t)),t,[x0 x0]);

n = 3;
e = x(:,n+1:end);
x = x(:,1:n);
x_est = x - e;

% Save state variables explicitly to aid in plotting
h = x(:,1); h_dot = x(:,2); i = x(:,3);
h_est = x_est(:,1); h_dot_est = x_est(:,2); i_est = x_est(:,3);

plot(t,h,'-r',t,h_est,':r',t,h_dot,'-b',t,h_dot_est,':b',t,i,'-g',t,i_est,':g')
xlabel('Time (sec)')

%%
% We can see that the observer estimates the states quickly and tracks the
% states well in the steady-state.


##### SOURCE END #####
-->				</div>
				
				<div id="left">

					<ul class="section">
						<li class="heading" id="System">SYSTEM<img class="section_heading_arrow" src="Images/section_heading_arrow.png"/></li>
						<li class="item" id="SystemModeling"><a href="indexf617.html?example=Introduction&amp;section=SystemModeling">MODELING<img class="section_arrow" src="Images/section_arrow.png"/></a></li>
						<li class="item" id="SystemAnalysis"><a href="indexa13b.html?example=Introduction&amp;section=SystemAnalysis">ANALYSIS<img class="section_arrow" src="Images/section_arrow.png"/></a></li>
					</ul>
					
					<div class="section_break"></div>

					<ul class="section">
						<li class="heading" id="Control">CONTROL<img class="section_heading_arrow" src="Images/section_heading_arrow.png"/></li>
						<li class="item" id="ControlPID"><a href="index6e33.html?example=Introduction&amp;section=ControlPID">PID<img class="section_arrow" src="Images/section_arrow.png"/></a></li>
						<li class="item" id="ControlRootLocus"><a href="indexe528.html?example=Introduction&amp;section=ControlRootLocus">ROOT&nbsp;LOCUS<img class="section_arrow" src="Images/section_arrow.png"/></a></li>
						<li class="item" id="ControlFrequency"><a href="index7f35.html?example=Introduction&amp;section=ControlFrequency">FREQUENCY<img class="section_arrow" src="Images/section_arrow.png"/></a></li>
						<li class="item" id="ControlStateSpace"><a href="index9b18.html?example=Introduction&amp;section=ControlStateSpace">STATE-SPACE<img class="section_arrow" src="Images/section_arrow.png"/></a></li>
						<li class="item" id="ControlDigital"><a href="index4e79.html?example=Introduction&amp;section=ControlDigital">DIGITAL<img class="section_arrow" src="Images/section_arrow.png"/></a></li>
					</ul>
					
					<div class="section_break"></div>

					<ul class="section">
						<li class="heading" id="Simulink">SIMULINK<img class="section_heading_arrow" src="Images/section_heading_arrow.png"/></li>
						<li class="item" id="SimulinkModeling"><a href="index5af4.html?example=Introduction&amp;section=SimulinkModeling">MODELING<img class="section_arrow" src="Images/section_arrow.png"/></a></li>
						<li class="item" id="SimulinkControl"><a href="index87ee.html?example=Introduction&amp;section=SimulinkControl">CONTROL<img class="section_arrow" src="Images/section_arrow.png"/></a></li>
					</ul>
		
				</div>
			
				<div style="clear:both"></div>
				
				<div id="bottombar"><span style="color:#FF5500;font-weight:bold">.</div>
				
			</div>
			
		</div>
	
		<script type="text/javascript" src="script.js"></script>
						
	</body>
	

<!-- Mirrored from ctms.engin.umich.edu/CTMS/index.php?example=Introduction&section=ControlStateSpace by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 19 Jun 2014 21:09:32 GMT -->
</html>

	StateSpace by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 19 Jun 2014 21:09:32 GMT -->
</html>

	
		<script type="text/javascript" src="script.js"></script>
						
	</body>
	

<!-- Mirrored from ctms.engin.umich.edu/CTMS/index.php?example=Introduction&section=ControlStateSpace by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 19 Jun 2014 21:09:32 GMT -->
</html>

	StateSpace by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 19 Jun 2014 21:09:32 GMT -->
</html>

	pier/3.x [XR&CO'2014], Thu, 19 Jun 2014 21:09:32 GMT -->
</html>

	StateSpace by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 19 Jun 2014 21:09:32 GMT -->
</html>

	